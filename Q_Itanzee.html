<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <!-- CSP
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:;">
    -->
    <title>Q.Itanzee - Aplikasi Kuitansi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§¾</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Lato&family=Roboto&family=Open+Sans&family=Montserrat&family=Merriweather&family=Playfair+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-light: #f3f4f6;
            --bg-dark: #1f2937;
            --card-light: #ffffff;
            --card-dark: #374151;
            --text-light: #111827;
            --text-dark: #f9fafb;
            --border-light: #d1d5db;
            --border-dark: #4b5563;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --soft-black: #374151;
        }

        .dark {
            --bg-light: #1f2937;
            --bg-dark: #f3f4f6;
            --card-light: #374151;
            --card-dark: #ffffff;
            --text-light: #f9fafb;
            --text-dark: #111827;
            --border-light: #4b5563;
            --border-dark: #d1d5db;
            --soft-black: #d1d5db;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
            font-family: 'Poppins', sans-serif;
        }
        
        .card {
            background-color: var(--card-light);
            border: 1px solid var(--border-light);
        }
        
        .input-field {
            background-color: var(--bg-light);
            border: 1px solid var(--border-light);
            color: var(--text-light);
        }

        .input-field:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .groupbox {
            border: 1px solid var(--border-light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
        }

        .groupbox-title {
            transform: translateY(-2.2rem);
            background-color: var(--card-light);
            padding: 0 0.5rem;
            font-weight: 600;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #pratinjau-modal #print-area, #pratinjau-modal #print-area * {
                visibility: visible;
            }
            #pratinjau-modal #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md transform translate-x-full invisible transition-transform duration-300 z-[60]">
        Pengaturan berhasil disimpan!
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <span class="text-3xl">ðŸ§¾</span>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Q.Itanzee</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500 dark:text-gray-400">Mode Gelap</span>
                <label for="theme-switch" class="flex items-center cursor-pointer">
                    <div class="relative">
                        <input type="checkbox" id="theme-switch" class="sr-only">
                        <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                        <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                    </div>
                </label>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex space-x-2 border-b border-[var(--border-light)] mb-6">
            <button data-tab="buat-kuitansi" class="tab-button py-2 px-4 font-semibold border-b-2 border-blue-500 text-blue-500">Buat Kuitansi</button>
            <button data-tab="rekap-data" class="tab-button py-2 px-4 font-semibold text-gray-500 dark:text-gray-400 border-b-2 border-transparent">Rekap Data</button>
            <button data-tab="pengaturan" class="tab-button py-2 px-4 font-semibold text-gray-500 dark:text-gray-400 border-b-2 border-transparent">Pengaturan</button>
        </nav>

        <main>
            <!-- Buat Kuitansi Section -->
            <section id="buat-kuitansi" class="tab-content card p-6 rounded-lg">
                <form id="form-kuitansi">
                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Detail Penerima</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label for="no-surat" class="block text-sm font-medium mb-1">No. Surat Kuitansi</label>
                                <div class="relative">
                                    <input type="text" id="no-surat" class="w-full p-2 rounded-md input-field" placeholder="0001">
                                    <div class="absolute inset-y-0 right-0 flex flex-col">
                                        <button type="button" class="px-1 text-xs btn-no-up" data-target="no-surat">â–²</button>
                                        <button type="button" class="px-1 text-xs btn-no-down" data-target="no-surat">â–¼</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label for="tanggal-pengeluaran" class="block text-sm font-medium mb-1">Tanggal Pengeluaran</label>
                                <input type="date" id="tanggal-pengeluaran" class="w-full p-2 rounded-md input-field">
                            </div>
                            <div>
                                <label for="nama-penerima" class="block text-sm font-medium mb-1">Nama Penerima</label>
                                <select id="nama-penerima" class="w-full p-2 rounded-md input-field"></select>
                            </div>
                            <div>
                                <label for="jabatan" class="block text-sm font-medium mb-1">Jabatan</label>
                                <select id="jabatan" class="w-full p-2 rounded-md input-field"></select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="keterangan-pembayaran" class="block text-sm font-medium mb-1">Keterangan Pembayaran</label>
                                <input type="text" id="keterangan-pembayaran" placeholder="Contoh: Pembayaran honorarium kegiatan..." class="w-full p-2 rounded-md input-field">
                            </div>
                            <div>
                                <label for="sumber-dana" class="block text-sm font-medium mb-1">Sumber Dana</label>
                                <select id="sumber-dana" class="w-full p-2 rounded-md input-field"></select>
                            </div>
                            <div>
                                <label for="jenis-transaksi" class="block text-sm font-medium mb-1">Jenis Transaksi</label>
                                <select id="jenis-transaksi" class="w-full p-2 rounded-md input-field">
                                    <option>Tunai</option>
                                    <option>Transfer Bank</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Rincian Transaksi</h3>
                        <div id="rincian-transaksi-container" class="space-y-3">
                            <!-- Dynamic rows will be inserted here -->
                        </div>
                        <button id="tambah-transaksi" type="button" class="mt-4 text-sm btn-primary py-1 px-3 rounded-md flex items-center space-x-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>Tambah Rincian</span>
                        </button>
                    </div>

                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Rincian Potongan</h3>
                        <div id="rincian-potongan-container" class="space-y-3">
                            <!-- Dynamic rows will be inserted here -->
                        </div>
                        <button id="tambah-potongan" type="button" class="mt-4 text-sm btn-primary py-1 px-3 rounded-md flex items-center space-x-1">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>Tambah Potongan</span>
                        </button>
                    </div>
                </form>

                <div class="mt-8 flex justify-end space-x-3">
                    <button id="simpan-kuitansi" class="btn-primary py-2 px-6 rounded-md font-semibold">Simpan Kuitansi</button>
                    <button id="pratinjau-cetak" class="bg-gray-700 text-white py-2 px-6 rounded-md font-semibold hover:bg-gray-800">Pratinjau & Cetak</button>
                </div>
            </section>

            <!-- Rekap Data Section -->
            <section id="rekap-data" class="tab-content card p-6 rounded-lg hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Rekap Data Transaksi</h2>
                    <div class="relative">
                        <input type="text" id="search-rekap" placeholder="Cari transaksi..." class="input-field p-2 pl-8 rounded-md">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div class="space-x-2">
                        <button id="hapus-terpilih" class="bg-red-500 text-white py-2 px-4 rounded-md text-sm hover:bg-red-600 disabled:bg-red-300 disabled:cursor-not-allowed">Hapus Terpilih</button>
                        <button id="ekspor-xlsx" class="bg-green-500 text-white py-2 px-4 rounded-md text-sm hover:bg-green-600">Ekspor .xlsx</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-[var(--border-light)]">
                        <thead class="bg-[var(--bg-light)]">
                            <tr>
                                <th scope="col" class="p-4 text-left text-xs font-medium uppercase tracking-wider">
                                    <input type="checkbox" id="tandai-semua" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                </th>
                                <th scope="col" class="p-4 text-left text-xs font-medium uppercase tracking-wider">Tanggal</th>
                                <th scope="col" class="p-4 text-left text-xs font-medium uppercase tracking-wider">No. Surat</th>
                                <th scope="col" class="p-4 text-left text-xs font-medium uppercase tracking-wider">Penerima</th>
                                <th scope="col" class="p-4 text-left text-xs font-medium uppercase tracking-wider">Keterangan</th>
                                <th scope="col" class="p-4 text-right text-xs font-medium uppercase tracking-wider">Total Nominal</th>
                                <th scope="col" class="p-4 text-right text-xs font-medium uppercase tracking-wider">Total Potongan</th>
                                <th scope="col" class="p-4 text-center text-xs font-medium uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rekap-tabel-body" class="divide-y divide-[var(--border-light)]">
                            <!-- Data rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Pengaturan Section -->
            <section id="pengaturan" class="tab-content card p-6 rounded-lg hidden">
                <div class="space-y-8">
                    
                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Tampilan Kuitansi</h3>
                        <div>
                            <label for="judul-kuitansi" class="block text-sm font-medium mb-1">Judul Kuitansi</label>
                            <input type="text" id="judul-kuitansi" placeholder="Kuitansi Serah Terima Uang" class="w-full md:w-1/2 p-2 rounded-md input-field">
                        </div>
                    </div>

                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Pengaturan Font Kuitansi</h3>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                             <div>
                                <label for="font-family" class="block text-sm font-medium mb-1">Jenis Font</label>
                                <select id="font-family" class="w-full p-2 rounded-md input-field"></select>
                            </div>
                             <div>
                                <label for="font-size" class="block text-sm font-medium mb-1">Ukuran Font</label>
                                <select id="font-size" class="w-full p-2 rounded-md input-field">
                                    <option value="10px">10px</option>
                                    <option value="11px">11px</option>
                                    <option value="12px">12px (Default)</option>
                                    <option value="14px">14px</option>
                                    <option value="16px">16px</option>
                                </select>
                            </div>
                            <div>
                                <label for="font-color" class="block text-sm font-medium mb-1">Warna Font</label>
                                <input type="color" id="font-color" class="w-full h-10 rounded-md input-field">
                            </div>
                        </div>
                    </div>

                    <!-- Penomoran -->
                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Penomoran Kuitansi</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="format-tambahan-surat" class="block text-sm font-medium mb-1">Format Tambahan No. Surat</label>
                                <input type="text" id="format-tambahan-surat" placeholder="/SMK-DA/IX/2025" class="w-full md:w-1/2 p-2 rounded-md input-field">
                            </div>
                            <div>
                                <label for="format-tambahan-rincian" class="block text-sm font-medium mb-1">Format Tambahan No. Rincian</label>
                                <input type="text" id="format-tambahan-rincian" placeholder="YYYY-MM-DD" class="w-full md:w-1/2 p-2 rounded-md input-field">
                                <p class="text-xs text-gray-500 mt-1">Gunakan YYYY-MM-DD untuk tanggal otomatis.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Data Instansi -->
                    <div class="groupbox">
                        <h3 class="groupbox-title w-max">Data Instansi</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="nama-yayasan" placeholder="Nama Yayasan" class="p-2 rounded-md input-field">
                            <input type="text" id="no-sk-yayasan" placeholder="No. SK Yayasan" class="p-2 rounded-md input-field">
                            <input type="text" id="nama-instansi" placeholder="Nama Instansi" class="p-2 rounded-md input-field font-bold">
                            <input type="text" id="alamat-1" placeholder="Alamat Baris 1" class="p-2 rounded-md input-field">
                            <input type="text" id="alamat-2" placeholder="Alamat Baris 2" class="p-2 rounded-md input-field">
                            <input type="text" id="tempat-terbit" placeholder="Tempat Terbit Kuitansi (contoh: Purbalingga)" class="p-2 rounded-md input-field">
                            <div>
                                <label class="block text-sm font-medium mb-1">Pilih Logo</label>
                                <input type="file" id="logo-instansi" accept="image/*" class="text-sm mt-2">
                                <img id="logo-preview" src="#" alt="Pratinjau Logo" class="mt-2 h-20 hidden rounded"/>
                            </div>
                        </div>
                    </div>
                    <!-- Personil & Sumber Dana -->
                    <div class="groupbox">
                         <h3 class="groupbox-title w-max">Data Personil & Sumber Dana</h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label for="nama-bendahara" class="block text-sm font-medium mb-1">Nama Bendahara</label>
                                <select id="nama-bendahara" class="w-full p-2 rounded-md input-field"></select>
                            </div>
                            <div>
                                <label for="jabatan-bendahara" class="block text-sm font-medium mb-1">Jabatan Bendahara</label>
                                <select id="jabatan-bendahara" class="w-full p-2 rounded-md input-field"></select>
                            </div>
                         </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="list-penerima" class="dynamic-list-container"></div>
                        <div id="list-jabatan" class="dynamic-list-container"></div>
                        <div id="list-sumber-dana" class="dynamic-list-container"></div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end">
                    <button id="simpan-pengaturan" class="btn-primary py-2 px-6 rounded-md font-semibold">Simpan Pengaturan</button>
                </div>
            </section>
        </main>
    </div>

    <!-- Pratinjau Modal -->
    <div id="pratinjau-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-4xl h-[90vh] rounded-lg shadow-2xl flex flex-col">
            <div class="p-4 bg-gray-100 rounded-t-lg flex justify-between items-center no-print">
                <h3 class="font-bold text-lg text-gray-800">Pratinjau Kuitansi</h3>
                <div class="space-x-2">
                    <button id="ekspor-pdf-modal" class="bg-red-500 text-white py-1 px-3 rounded-md text-sm hover:bg-red-600">Ekspor .PDF</button>
                    <button id="cetak-modal" onclick="window.print()" class="btn-primary py-1 px-3 rounded-md text-sm">Cetak</button>
                    <button id="close-modal" class="bg-gray-300 text-gray-800 py-1 px-3 rounded-md text-sm hover:bg-gray-400">Close</button>
                </div>
            </div>
            <div class="overflow-y-auto p-2">
                <div id="print-area" class="bg-white p-8">
                    <!-- Header Kuitansi -->
                    <header class="flex items-stretch justify-between print-header">
                        <img id="logo-kuitansi" src="" class="h-auto w-24 object-contain"/>
                        <div id="instansi-header" class="text-right flex flex-col justify-between">
                            <div>
                                <p id="yayasan-kuitansi" class="font-bold text-lg"></p>
                                <p id="sk-kuitansi" class="text-xs"></p>
                                <p id="instansi-kuitansi" class="font-bold text-2xl"></p>
                            </div>
                            <div>
                                <p id="alamat1-kuitansi" class="text-sm"></p>
                                <p id="alamat2-kuitansi" class="text-sm"></p>
                            </div>
                        </div>
                    </header>
                    <!-- Judul Kuitansi -->
                    <h2 id="judul-kuitansi-preview" class="text-center font-bold text-lg my-2 print-title"></h2>
                    <p id="no-surat-preview" class="text-center text-sm mb-6"></p>
                    <!-- Detail -->
                    <div class="text-sm space-y-1 detail-table">
                        <table class="w-full">
                            <tr><td>Sudah Diterima Dari</td><td id="pemberi-dana-preview" class="font-bold">: Bendahara</td></tr>
                            <tr><td>Nama Penerima</td><td id="penerima-preview" class="font-bold">: </td></tr>
                            <tr><td>Jabatan</td><td id="jabatan-preview" class="font-bold">: </td></tr>
                            <tr><td>Uang Sejumlah</td><td id="sejumlah-preview" class="font-bold text-lg" style="color: #2563eb;">: </td></tr>
                            <tr><td>Terbilang</td><td id="terbilang-preview" class="font-bold italic">: </td></tr>
                            <tr><td>Untuk Pembayaran</td><td id="keterangan-preview" class="font-bold">: </td></tr>
                        </table>
                    </div>
                    
                    <p class="text-sm my-4">Dengan rincian sebagai berikut:</p>

                    <!-- Tabel Rincian -->
                    <table class="w-full text-sm rincian-table border-collapse border border-gray-300">
                        <thead>
                            <tr class="border-b-2 border-gray-400">
                                <th class="text-center w-[5%] border border-gray-300">No.</th>
                                <th class="text-center w-[25%] border border-gray-300">No. Transaksi</th>
                                <th class="text-center border border-gray-300">Keterangan</th>
                                <th class="text-center w-[25%] border border-gray-300">Nominal</th>
                            </tr>
                        </thead>
                        <tbody id="rincian-preview-body"></tbody>
                    </table>
                    
                    <div id="potongan-section" class="hidden mt-4">
                         <p class="text-sm my-4">Dengan rincian potongan sebagai berikut:</p>
                        <table class="w-full text-sm rincian-table border-collapse border border-gray-300">
                            <thead>
                                <tr class="border-b-2 border-gray-400" style="background-color: #FFEBEB; font-weight: 600;">
                                    <th class="text-center w-[5%] border border-gray-300 p-2">No.</th>
                                    <th class="text-center border border-gray-300 p-2">Keterangan Potongan</th>
                                    <th class="text-center w-[25%] border border-gray-300 p-2">Nominal</th>
                                </tr>
                            </thead>
                            <tbody id="potongan-preview-body"></tbody>
                        </table>
                    </div>

                    <table class="w-full text-sm rincian-table mt-4">
                         <tfoot>
                            <tr>
                                <td colspan="2" class="text-right font-bold p-2">Subtotal</td>
                                <td id="subtotal-preview" class="text-right font-bold p-2 w-[25%]"></td>
                            </tr>
                            <tr>
                                <td colspan="2" class="text-right p-2">Potongan</td>
                                <td id="potongan-preview" class="text-right p-2"></td>
                            </tr>
                             <tr style="background-color: #EBF4FF; font-weight: bold;">
                                <td colspan="2" class="text-right text-base p-3">TOTAL DITERIMA</td>
                                <td id="total-preview" class="text-right text-base p-3"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Tanda Tangan -->
                    <div class="flex justify-between mt-12 text-sm">
                        <div class="w-1/3 text-center">
                            <p class="mb-16">Pengeluar Dana,</p>
                            <p id="bendahara-ttd-preview" class="font-bold underline"></p>
                            <p id="jabatan-bendahara-ttd-preview"></p>
                        </div>
                        <div class="w-1/3 text-center">
                            <p id="tempat-tanggal-ttd-preview" class="h-6 mb-4"></p>
                            <p class="mb-16">Penerima Dana,</p>
                            <p id="penerima-ttd-preview" class="font-bold underline"></p>
                            <p id="jabatan-penerima-ttd-preview"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script type="module">
// --- UTILITIES ---
const $ = (selector) => document.querySelector(selector);
const $$ = (selector) => document.querySelectorAll(selector);

// --- APP STATE ---
let appState = {
    settings: {
        judulKuitansi: 'Kuitansi Serah Terima Uang',
        fontFamily: 'Poppins',
        fontSize: '12px',
        fontColor: '#374151',
        formatTambahanSurat: '/SMK-DA/IX/2025',
        formatTambahanRincian: 'YYYY-MM-DD',
        namaYayasan: 'YAYASAN PONDOK PESANTREN DARUL ABROR',
        noSkYayasan: 'SK MENKUMHAM NOMOR AHU-600.AH.01.02 TAHUN 2008',
        namaInstansi: 'SMK DARUL ABROR',
        alamat1: 'Jalan Warudoyong RT 05 RW 03 Kec. Bukateja Kab. Purbalingga Kode Pos 53382',
        alamat2: 'Telp. (0286) 5213462 Email: smk.darulabror@gmail.com Website: smkdarulabror.sch.id',
        tempatTerbit: 'Purbalingga',
        logo: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9ImN1cnJlbnRDb2xvciIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0xNCAySDZhMiAyIDAgMCAwLTIgMnYxNmEyIDIgMCAwIDAgMiAyaDEyYTcgMiAwIDAgMCAyLTJWOXoiPjwvcGF0aD48cG9seWxpbmUgcG9pbnRzPSIxNCAyIDE0IDggMjAgOCI+PC9wb2x5bGluZT48bGluZSB4MT0iMTYiIHkxPSIxMyIgeDI9IjgiIHkyPSIxMyI+PC9saW5lPjxsaW5lIHgxPSIxNiIgeTE9IjE3IiB4Mj0iOCIgeTI9IjE3Ij48L2xpbmU+PHBvbHlsaW5lIHBvaW50cz0iMTAgOSA5IDkgOCA5Ij48L3BvbHlsaW5lPjwvc3ZnPg==',
        namaBendahara: 'Achmad Ali Hasan',
        jabatanBendahara: 'Bendahara Komite',
        penerimaList: ['Achmad Ali Hasan', 'Afri Nur Khalimah, S.S.T.Ars.', 'Agus Buryadi', 'Ali Basyar, S.S.', 'Andri Susianto, S.Kom.', 'Anggi Dian Rosalinda, S.M.', 'Anggita Alfa Zahro, S.Pd.', 'Dian Aprilia Susanti', 'Dwi Wardoyo, S.Pd.', 'Fakhrul Fatoni, S.Ag.', 'Isnaeni Nur Azizah, S.Pd.', 'Lilin Apriyani, S.Pd.', 'Listyaningrum Eka Wulandari, S.Kom.', 'Lulu Shafira, S.Kom.', 'Maful Hidayat,S.Pd.I., M.Pd.', 'Mei Fadlillah, S.Kom.', 'Mufidatul Lailiy, S.Pd.', 'Muhlis', 'Roâ€™fatus Sharofah', 'Siti Nurokhmah, S.Pd.', 'Syafiqul Umam, Lc.', 'Syarif Hidayatuloh', 'Umi Robiatul Walinda Asmara, S.Ag.', 'Yuyun Musyarofah, S.Sos.'],
        jabatanList: ['Kepala Sekolah', 'Wakil Kepala Sekolah', 'Kasubag TU', 'Staf TU', 'Waka SDM', 'Staf Waka SDM', 'Waka Kurikulum', 'Staf Waka Kurikulum', 'Waka Kesiswaan', 'Staf Waka Kesiswaan', 'Waka Sarpras', 'Staf Waka Sarpras', 'Waka Humas', 'Staf Waka Humas', 'Kaproli', 'Staf Kaproli', 'Bendahara', 'Staf Bendahara', 'Guru', 'Guru BK', 'Toolman', 'Caraka'],
        sumberDanaList: ['Bendahara Komite', 'Bendahara BOSP', 'Bendahara BOSDA', 'Bendahara Taktis'],
    },
    transactions: [],
    editingTransactionId: null,
};
let currentPratinjauData = null;

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadState();
    initTheme();
    initTabs();
    populateFontList();
    initEventListeners();
    populateDropdowns();
    renderDynamicLists();
    addTransaksiRow(); 
    $('#tanggal-pengeluaran').value = new Date().toISOString().split('T')[0];
    renderRekapTable();
    updateHapusTerpilihButton();
    applyFontSettings();
});

function loadState() {
    const savedState = localStorage.getItem('qItanzeeState');
    if (savedState) {
        const parsedState = JSON.parse(savedState);
        appState.settings = {...appState.settings, ...parsedState.settings};
        appState.transactions = parsedState.transactions || [];
    }
    applySettingsToForm();
}

function saveState() {
    localStorage.setItem('qItanzeeState', JSON.stringify({
        settings: appState.settings,
        transactions: appState.transactions
    }));
}

// --- THEME ---
function initTheme() {
    const themeSwitch = $('#theme-switch');
    const html = document.documentElement;
    const savedTheme = localStorage.getItem('theme') || 'light';

    if (savedTheme === 'dark') {
        html.classList.add('dark');
        themeSwitch.checked = true;
    }

    themeSwitch.addEventListener('change', () => {
        if (themeSwitch.checked) {
            html.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            html.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    });
}

// --- TABS ---
function initTabs() {
    const tabButtons = $$('.tab-button');
    const tabContents = $$('.tab-content');

    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tab = button.dataset.tab;

            tabButtons.forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-500');
                btn.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
            });
            button.classList.add('border-blue-500', 'text-blue-500');
            button.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');

            tabContents.forEach(content => {
                if (content.id === tab) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        });
    });
}

// --- EVENT LISTENERS ---
function initEventListeners() {
    $('#simpan-pengaturan').addEventListener('click', handleSimpanPengaturan);
    $('#logo-instansi').addEventListener('change', handleLogoChange);
    $('#tambah-transaksi').addEventListener('click', () => addTransaksiRow());
    $('#tambah-potongan').addEventListener('click', () => addPotonganRow());
    $('#simpan-kuitansi').addEventListener('click', handleSimpanKuitansi);
    $('#pratinjau-cetak').addEventListener('click', handlePratinjauCetak); 
    $('#close-modal').addEventListener('click', () => $('#pratinjau-modal').classList.add('hidden'));
    $('#ekspor-pdf-modal').addEventListener('click', () => handleExportPDF(currentPratinjauData));
    $('#tandai-semua').addEventListener('change', handleTandaiSemua);
    $('#rekap-tabel-body').addEventListener('change', (e) => {
        if (e.target.classList.contains('row-checkbox')) {
            updateHapusTerpilihButton();
        }
    });
    $('#hapus-terpilih').addEventListener('click', handleHapusTerpilih);
    $('#ekspor-xlsx').addEventListener('click', handleExportXLSX);
    $('#keterangan-pembayaran').addEventListener('input', autoFillKeterangan);
    $('#search-rekap').addEventListener('input', (e) => renderRekapTable(e.target.value));
    
    // Number input listeners
    $$('.btn-no-up, .btn-no-down').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const targetId = e.currentTarget.dataset.target;
            const input = $(`#${targetId}`);
            let val = parseInt(input.value, 10) || 0;
            if (e.currentTarget.classList.contains('btn-no-up')) {
                val++;
            } else if (val > 1) {
                val--;
            }
            input.value = val.toString().padStart(4, '0');
        });
    });

    $('#no-surat').addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^0-9]/g, ''); });
    $('#no-surat').addEventListener('blur', (e) => { if(e.target.value) e.target.value = e.target.value.padStart(4, '0'); });
}


function autoFillKeterangan(e) {
    const firstRincian = $('#rincian-transaksi-container .rincian-row .keterangan');
    if (firstRincian) {
        firstRincian.value = e.target.value;
    }
}

// --- PENGATURAN ---
function applySettingsToForm() {
    $('#judul-kuitansi').value = appState.settings.judulKuitansi;
    $('#font-family').value = appState.settings.fontFamily;
    $('#font-size').value = appState.settings.fontSize;
    $('#font-color').value = appState.settings.fontColor;
    $('#format-tambahan-surat').value = appState.settings.formatTambahanSurat;
    $('#format-tambahan-rincian').value = appState.settings.formatTambahanRincian;
    $('#nama-yayasan').value = appState.settings.namaYayasan;
    $('#no-sk-yayasan').value = appState.settings.noSkYayasan;
    $('#nama-instansi').value = appState.settings.namaInstansi;
    $('#alamat-1').value = appState.settings.alamat1;
    $('#alamat-2').value = appState.settings.alamat2;
    $('#tempat-terbit').value = appState.settings.tempatTerbit;
    populateDropdowns(); 
    $('#nama-bendahara').value = appState.settings.namaBendahara;
    $('#jabatan-bendahara').value = appState.settings.jabatanBendahara;
    if (appState.settings.logo) {
        $('#logo-preview').src = appState.settings.logo;
        $('#logo-preview').classList.remove('hidden');
    }
}

function handleSimpanPengaturan() {
    appState.settings.judulKuitansi = $('#judul-kuitansi').value;
    appState.settings.fontFamily = $('#font-family').value;
    appState.settings.fontSize = $('#font-size').value;
    appState.settings.fontColor = $('#font-color').value;
    appState.settings.formatTambahanSurat = $('#format-tambahan-surat').value;
    appState.settings.formatTambahanRincian = $('#format-tambahan-rincian').value;
    appState.settings.namaYayasan = $('#nama-yayasan').value;
    appState.settings.noSkYayasan = $('#no-sk-yayasan').value;
    appState.settings.namaInstansi = $('#nama-instansi').value;
    appState.settings.alamat1 = $('#alamat-1').value;
    appState.settings.alamat2 = $('#alamat-2').value;
    appState.settings.tempatTerbit = $('#tempat-terbit').value;
    appState.settings.namaBendahara = $('#nama-bendahara').value;
    appState.settings.jabatanBendahara = $('#jabatan-bendahara').value;
    
    saveState();
    populateDropdowns();
    applyFontSettings();
    showToast('Pengaturan berhasil disimpan!');
}

function applyFontSettings() {
    const printArea = $('#pratinjau-modal #print-area');
    printArea.style.fontFamily = appState.settings.fontFamily;
    printArea.style.fontSize = appState.settings.fontSize;
    printArea.style.color = appState.settings.fontColor;
}


function handleLogoChange(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            appState.settings.logo = e.target.result;
            $('#logo-preview').src = e.target.result;
            $('#logo-preview').classList.remove('hidden');
            saveState();
        }
        reader.readAsDataURL(file);
    }
}

function showLogoInput(type) {
    if (type === 'galeri') {
        $('#logo-instansi').classList.remove('hidden');
        $('#logo-link-input').classList.add('hidden');
    } else {
        $('#logo-instansi').classList.add('hidden');
        $('#logo-link-input').classList.remove('hidden');
    }
}

function handleLogoLink(event) {
    const url = event.target.value;
    if (url) {
        appState.settings.logo = url;
        $('#logo-preview').src = url;
        $('#logo-preview').classList.remove('hidden');
        saveState();
    }
}


function showToast(message) {
    const toast = $('#toast');
    toast.textContent = message;
    toast.classList.remove('invisible', 'translate-x-full');
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        toast.addEventListener('transitionend', () => {
            toast.classList.add('invisible');
        }, { once: true });
    }, 3000);
}

// DYNAMIC LISTS (PENGATURAN)
function createDynamicList(title, listKey) {
    const container = document.createElement('div');
    container.className = 'p-4 border border-[var(--border-light)] rounded-lg h-full flex flex-col';
    
    const titleEl = document.createElement('h4');
    titleEl.className = 'font-semibold mb-2';
    titleEl.textContent = title;
    container.appendChild(titleEl);
    
    const listContainer = document.createElement('div');
    listContainer.className = 'space-y-2 flex-grow overflow-y-auto pr-2 max-h-60';
    listContainer.id = `dynamic-list-${listKey}`;
    container.appendChild(listContainer);
    
    const inputContainer = document.createElement('div');
    inputContainer.className = 'flex mt-4 space-x-2';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = `Tambah ${title}...`;
    input.className = 'w-full p-2 text-sm rounded-md input-field';
    
    const addButton = document.createElement('button');
    addButton.textContent = '+';
    addButton.className = 'btn-primary px-3 rounded-md font-bold';
    addButton.onclick = () => {
        if (input.value.trim()) {
            appState.settings[listKey].push(input.value.trim());
            renderDynamicLists();
            saveState();
            populateDropdowns();
            input.value = '';
        }
    };
    
    inputContainer.appendChild(input);
    inputContainer.appendChild(addButton);
    container.appendChild(inputContainer);
    
    return container;
}

function renderDynamicLists() {
    const listConfigs = [
        { title: 'Daftar Nama Penerima', key: 'penerimaList', containerId: 'list-penerima' },
        { title: 'Daftar Jabatan', key: 'jabatanList', containerId: 'list-jabatan' },
        { title: 'Daftar Sumber Dana', key: 'sumberDanaList', containerId: 'list-sumber-dana' }
    ];

    listConfigs.forEach(config => {
        const container = $(`#${config.containerId}`);
        container.innerHTML = '';
        container.appendChild(createDynamicList(config.title, config.key));
        
        const listEl = $(`#dynamic-list-${config.key}`);
        listEl.innerHTML = '';
        appState.settings[config.key].forEach((item, index) => {
            const itemEl = document.createElement('div');
            itemEl.className = 'flex items-center justify-between bg-[var(--bg-light)] p-2 rounded';
            itemEl.innerHTML = `
                <span class="text-sm">${item}</span>
                <button data-index="${index}" data-key="${config.key}" class="text-red-500 hover:text-red-700 text-xs">Hapus</button>
            `;
            listEl.appendChild(itemEl);
        });
    });

    $$('.dynamic-list-container button').forEach(button => {
        button.addEventListener('click', (e) => {
            if (e.target.dataset.index !== undefined) {
                const key = e.target.dataset.key;
                const index = parseInt(e.target.dataset.index, 10);
                appState.settings[key].splice(index, 1);
                renderDynamicLists();
                saveState();
                populateDropdowns();
            }
        });
    });
}

// --- BUAT KUITANSI ---
function populateDropdowns() {
    const penerimaSelect = $('#nama-penerima');
    const jabatanSelect = $('#jabatan');
    const sumberDanaSelect = $('#sumber-dana');
    const bendaharaSelect = $('#nama-bendahara');
    const jabatanBendaharaSelect = $('#jabatan-bendahara');
    
    const penerimaOptions = appState.settings.penerimaList.map(p => `<option value="${p}">${p}</option>`).join('');
    penerimaSelect.innerHTML = penerimaOptions;
    bendaharaSelect.innerHTML = penerimaOptions;
    
    jabatanSelect.innerHTML = appState.settings.jabatanList.map(j => `<option value="${j}">${j}</option>`).join('');
    
    const sumberDanaOptions = appState.settings.sumberDanaList.map(s => `<option value="${s}">${s}</option>`).join('');
    sumberDanaSelect.innerHTML = sumberDanaOptions;
    jabatanBendaharaSelect.innerHTML = sumberDanaOptions;
}

function populateFontList() {
    const fontSelect = $('#font-family');
    const fonts = [
        'Poppins', 'Arial', 'Verdana', 'Helvetica', 'Tahoma', 'Trebuchet MS', 'Times New Roman', 'Georgia', 'Garamond',
        'Courier New', 'Brush Script MT', 'Calibri', 'Cambria', 'Candara', 'Century Gothic', 'Consolas', 'Constantia',
        'Corbel', 'Franklin Gothic Medium', 'Gill Sans', 'Impact', 'Lucida Console', 'Lucida Sans Unicode', 'Optima',
        'Palatino Linotype', 'Rockwell', 'Segoe UI', 'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Merriweather', 'Playfair Display'
    ];
    fontSelect.innerHTML = fonts.map(f => `<option value="${f}">${f}</option>`).join('');
}


function createRincianRow(type, data = {}) {
    const container = type === 'transaksi' ? $('#rincian-transaksi-container') : $('#rincian-potongan-container');
    const row = document.createElement('div');
    row.className = 'grid grid-cols-12 gap-2 items-center rincian-row';
    
    let noTransaksiInput = '';
    if (type === 'transaksi') {
        const nextNo = ($$('#rincian-transaksi-container .rincian-row').length + 1).toString().padStart(4, '0');
        const noValue = data.noTransaksi || nextNo;
        noTransaksiInput = `
            <div class="col-span-12 md:col-span-2">
                 <div class="relative">
                    <input type="text" value="${noValue}" class="w-full p-2 rounded-md input-field no-transaksi" placeholder="No.">
                    <div class="absolute inset-y-0 right-0 flex flex-col">
                        <button type="button" class="px-1 text-xs btn-no-up" data-target-rincian>â–²</button>
                        <button type="button" class="px-1 text-xs btn-no-down" data-target-rincian>â–¼</button>
                    </div>
                </div>
            </div>`;
    }

    const keteranganValue = data.keterangan || '';
    const nominalValue = data.nominal ? formatRupiah(data.nominal) : '';

    row.innerHTML = `
        ${noTransaksiInput}
        <div class="col-span-12 ${type === 'transaksi' ? 'md:col-span-6' : 'md:col-span-8'}">
            <input type="text" value="${keteranganValue}" class="w-full p-2 rounded-md input-field keterangan" placeholder="Keterangan">
        </div>
        <div class="col-span-10 md:col-span-3">
            <input type="text" value="${nominalValue}" class="w-full p-2 rounded-md input-field nominal" placeholder="Nominal">
        </div>
        <div class="col-span-2 md:col-span-1 flex justify-center items-center">
            <button class="text-red-500 hover:text-red-700 p-2 rounded-full remove-row-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
            </button>
        </div>
    `;

    row.querySelector('.remove-row-btn').addEventListener('click', () => {
        row.remove();
    });

    if (type === 'transaksi') {
        const noInput = row.querySelector('.no-transaksi');
         noInput.addEventListener('input', () => {
            noInput.value = noInput.value.replace(/[^0-9]/g, '');
        });
        noInput.addEventListener('blur', () => {
            if(noInput.value) {
                noInput.value = noInput.value.padStart(4, '0');
            }
        });
        row.querySelector('[data-target-rincian].btn-no-up').addEventListener('click', () => {
            let val = parseInt(noInput.value, 10) || 0;
            noInput.value = (val + 1).toString().padStart(4, '0');
        });
        row.querySelector('[data-target-rincian].btn-no-down').addEventListener('click', () => {
            let val = parseInt(noInput.value, 10) || 0;
            if (val > 1) {
                noInput.value = (val - 1).toString().padStart(4, '0');
            }
        });
    }
    
    const nominalInput = row.querySelector('.nominal');
    nominalInput.addEventListener('input', (e) => {
        e.target.value = formatRupiah(e.target.value);
    });

    container.appendChild(row);
}

function addTransaksiRow(data = {}) {
    createRincianRow('transaksi', data);
    if ($$('#rincian-transaksi-container .rincian-row').length === 1 && !data.keterangan) {
       autoFillKeterangan({ target: $('#keterangan-pembayaran') });
    }
}

function addPotonganRow(data = {}) {
    createRincianRow('potongan', data);
}

function parseRupiah(rupiahStr) {
    return parseInt((rupiahStr || '').toString().replace(/[^0-9]/g, ''), 10) || 0;
}

function formatRupiah(angka, prefix) {
    let number_string = (angka || '').toString().replace(/[^,\d]/g, ''),
        split = number_string.split(','),
        sisa = split[0].length % 3,
        rupiah = split[0].substr(0, sisa),
        ribuan = split[0].substr(sisa).match(/\d{3}/gi);

    if (ribuan) {
        let separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.');
    }

    rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
    return prefix == undefined ? rupiah : (rupiah ? 'Rp ' + rupiah : 'Rp 0');
}

function formatDateDDMMYYYY(dateString) {
    const date = dateString ? new Date(dateString + 'T00:00:00') : new Date();
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function formatDateLong(dateString) {
    const date = dateString ? new Date(dateString + 'T00:00:00') : new Date();
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return date.toLocaleDateString('id-ID', options);
}

function handleSimpanKuitansi() {
    const kuitansiData = getKuitansiDataFromForm();
    if (!kuitansiData) return;

    if (appState.editingTransactionId) {
        const index = appState.transactions.findIndex(t => t.id === appState.editingTransactionId);
        if (index > -1) {
            appState.transactions[index] = { ...kuitansiData, id: appState.editingTransactionId };
        }
        appState.editingTransactionId = null;
        $('#simpan-kuitansi').textContent = 'Simpan Kuitansi';
        showToast('Kuitansi berhasil diperbarui!');
    } else {
        appState.transactions.push({ ...kuitansiData, id: Date.now() });
        showToast('Kuitansi berhasil disimpan!');
    }
    
    saveState();
    resetFormKuitansi();
    renderRekapTable();
    $('.tab-button[data-tab="rekap-data"]').click();
}

function getKuitansiDataFromForm() {
    const rincianTransaksi = Array.from($('#rincian-transaksi-container').querySelectorAll('.rincian-row')).map(row => ({
        noTransaksi: row.querySelector('.no-transaksi').value,
        keterangan: row.querySelector('.keterangan').value,
        nominal: parseRupiah(row.querySelector('.nominal').value)
    })).filter(item => item.keterangan || item.nominal > 0);

    if (rincianTransaksi.length === 0) {
        alert('Mohon isi minimal satu rincian transaksi.');
        return null;
    }

    const rincianPotongan = Array.from($('#rincian-potongan-container').querySelectorAll('.rincian-row')).map(row => ({
        keterangan: row.querySelector('.keterangan').value,
        nominal: parseRupiah(row.querySelector('.nominal').value)
    })).filter(item => item.keterangan || item.nominal > 0);

    return {
        noSurat: $('#no-surat').value,
        namaPenerima: $('#nama-penerima').value,
        jabatan: $('#jabatan').value,
        keteranganPembayaran: $('#keterangan-pembayaran').value,
        sumberDana: $('#sumber-dana').value,
        jenisTransaksi: $('#jenis-transaksi').value,
        tanggalPengeluaran: $('#tanggal-pengeluaran').value || new Date().toISOString().split('T')[0],
        rincianTransaksi,
        rincianPotongan,
    };
}

function resetFormKuitansi() {
    $('#form-kuitansi').reset();
    $('#rincian-transaksi-container').innerHTML = '';
    $('#rincian-potongan-container').innerHTML = '';
    addTransaksiRow();
    $('#tanggal-pengeluaran').value = new Date().toISOString().split('T')[0];
    const nextNoSurat = (appState.transactions.length + 1).toString().padStart(4, '0');
    $('#no-surat').value = nextNoSurat;
    appState.editingTransactionId = null;
    $('#simpan-kuitansi').textContent = 'Simpan Kuitansi';
}

// --- PRATINJAU & CETAK ---
function handlePratinjauCetak() {
    const data = getKuitansiDataFromForm();
    if (!data) return;
    populatePratinjauModal(data);
    $('#pratinjau-modal').classList.remove('hidden');
}

function populatePratinjauModal(data) {
    currentPratinjauData = data;
    const { settings } = appState;
    $('#logo-kuitansi').src = settings.logo || '';
    $('#logo-kuitansi').style.display = settings.logo ? 'block' : 'none';
    
    $('#yayasan-kuitansi').textContent = settings.namaYayasan;
    $('#sk-kuitansi').textContent = settings.noSkYayasan;
    $('#instansi-kuitansi').textContent = settings.namaInstansi;
    $('#alamat1-kuitansi').textContent = settings.alamat1;
    $('#alamat2-kuitansi').textContent = settings.alamat2;
    $('#judul-kuitansi-preview').textContent = settings.judulKuitansi;
    
    $('#no-surat-preview').textContent = `No: ${data.noSurat}${settings.formatTambahanSurat}`;
    $('#penerima-preview').innerHTML = `: <span style="font-weight: 600;">${data.namaPenerima}</span>`;
    $('#jabatan-preview').innerHTML = `: <span style="font-weight: 600;">${data.jabatan}</span>`;
    $('#keterangan-preview').innerHTML = `: <span style="font-weight: 600;">${data.keteranganPembayaran}</span>`;

    const subtotal = data.rincianTransaksi.reduce((sum, item) => sum + item.nominal, 0);
    const totalPotongan = data.rincianPotongan.reduce((sum, item) => sum + item.nominal, 0);
    const totalDiterima = subtotal - totalPotongan;

    $('#sejumlah-preview').innerHTML = `: <span style="font-weight: 600; font-size: 1.125rem; color: #2563eb;">${formatRupiah(totalDiterima, 'Rp')}</span>`;
    $('#terbilang-preview').innerHTML = `: <span style="font-weight: 600; font-style: italic;">${toTitleCase(terbilang(totalDiterima))} Rupiah</span>`;

    const rincianBody = $('#rincian-preview-body');
    rincianBody.innerHTML = '';
    
    let rincianToDisplay = data.rincianTransaksi;
    if (rincianToDisplay.length === 0 || (rincianToDisplay.length === 1 && !rincianToDisplay[0].keterangan && !rincianToDisplay[0].nominal)) {
        rincianToDisplay = [{
            noTransaksi: data.rincianTransaksi[0]?.noTransaksi || '0001',
            keterangan: data.keteranganPembayaran,
            nominal: subtotal,
        }];
    }

    rincianToDisplay.forEach((item, index) => {
        const row = rincianBody.insertRow();
        const tgl = new Date(data.tanggalPengeluaran + 'T00:00:00');
        const formattedDate = settings.formatTambahanRincian
            .replace('YYYY', tgl.getFullYear())
            .replace('MM', String(tgl.getMonth() + 1).padStart(2, '0'))
            .replace('DD', String(tgl.getDate()).padStart(2, '0'));

        row.innerHTML = `
            <td class="text-center border border-gray-300 p-2">${index + 1}</td>
            <td class="text-center border border-gray-300 p-2">${formattedDate}-${item.noTransaksi}</td>
            <td class="border border-gray-300 p-2">${item.keterangan}</td>
            <td class="text-right border border-gray-300 p-2">${formatRupiah(item.nominal)}</td>
        `;
    });

    const potonganSection = $('#potongan-section');
    const potonganBody = $('#potongan-preview-body');
    potonganBody.innerHTML = '';
    if (data.rincianPotongan.length > 0) {
        data.rincianPotongan.forEach((item, index) => {
            const row = potonganBody.insertRow();
            row.innerHTML = `
                <td class="text-center border border-gray-300 p-2">${index + 1}</td>
                <td class="border border-gray-300 p-2">${item.keterangan}</td>
                <td class="text-right border border-gray-300 p-2">${formatRupiah(item.nominal)}</td>
            `;
        });
        potonganSection.style.display = 'block';
    } else {
        potonganSection.style.display = 'none';
    }
    
    $('#subtotal-preview').textContent = formatRupiah(subtotal);
    $('#potongan-preview').textContent = totalPotongan > 0 ? `(${formatRupiah(totalPotongan)})` : `-`;
    $('#total-preview').textContent = formatRupiah(totalDiterima);

    $('#tempat-tanggal-ttd-preview').textContent = `${settings.tempatTerbit}, ${formatDateLong(data.tanggalPengeluaran)}`;
    $('#bendahara-ttd-preview').textContent = settings.namaBendahara;
    $('#jabatan-bendahara-ttd-preview').textContent = settings.jabatanBendahara;
    $('#penerima-ttd-preview').textContent = data.namaPenerima;
    $('#jabatan-penerima-ttd-preview').textContent = data.jabatan;
}

function toTitleCase(str) {
    return str.replace(
        /\w\S*/g,
        (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
    );
}

function terbilang(n) {
    if (n === null || n === undefined) return "Nol";
    if (n === 0) return "Nol";
    
    const bilangan = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
    
    function _terbilang(n) {
        if (n < 12) {
            return bilangan[n];
        } else if (n < 20) {
            return _terbilang(n - 10) + " belas";
        } else if (n < 100) {
            return _terbilang(Math.floor(n / 10)) + " puluh" + (_terbilang(n % 10) ? " " + _terbilang(n % 10) : "");
        } else if (n < 200) {
            return "seratus" + (_terbilang(n - 100) ? " " + _terbilang(n - 100) : "");
        } else if (n < 1000) {
            return _terbilang(Math.floor(n / 100)) + " ratus" + (_terbilang(n % 100) ? " " + _terbilang(n % 100) : "");
        } else if (n < 2000) {
            return "seribu" + (_terbilang(n - 1000) ? " " + _terbilang(n - 1000) : "");
        } else if (n < 1000000) {
            return _terbilang(Math.floor(n / 1000)) + " ribu" + (_terbilang(n % 1000) ? " " + _terbilang(n % 1000) : "");
        } else if (n < 1000000000) {
            return _terbilang(Math.floor(n / 1000000)) + " juta" + (_terbilang(n % 1000000) ? " " + _terbilang(n % 1000000) : "");
        } else if (n < 1000000000000) {
            return _terbilang(Math.floor(n / 1000000000)) + " milyar" + (_terbilang(n % 1000000000) ? " " + _terbilang(n % 1000000000) : "");
        }
        return "";
    }
    
    return _terbilang(Math.abs(n)).trim();
}


async function handleExportPDF(data) {
    if (!data) {
        alert("Tidak ada data untuk diekspor ke PDF.");
        return;
    }
    populatePratinjauModal(data); // Populate the modal to get the print area ready

    // Wait for the logo image to load before rendering canvas
    const logoImg = document.querySelector('#pratinjau-modal #logo-kuitansi');
    const imageLoadPromise = new Promise((resolve) => {
        if (!logoImg.src || logoImg.complete) {
            resolve();
            return;
        }
        logoImg.onload = resolve;
        logoImg.onerror = resolve; // Resolve even on error to not block PDF generation
    });

    await imageLoadPromise;

    const { jsPDF } = window.jspdf;
    const printArea = document.querySelector('#pratinjau-modal #print-area');
    
    try {
        const canvas = await html2canvas(printArea, { scale: 3, useCORS: true });
        const imgData = canvas.toDataURL('image/png');
        
        const pdf = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        
        const noKuitansi = data.noSurat || 'kuitansi';
        pdf.save(`kuitansi-${noKuitansi}.pdf`);
    } catch (error) {
        console.error("Gagal membuat PDF:", error);
        alert("Gagal membuat PDF. Coba gunakan logo dari link atau logo yang lebih sederhana.");
    }
}

// --- REKAP DATA ---
function renderRekapTable(searchTerm = '') {
    const tbody = $('#rekap-tabel-body');
    tbody.innerHTML = '';
    
    const lowerCaseSearchTerm = searchTerm.toLowerCase();

    const filteredTransactions = appState.transactions.filter(trx => {
        const searchText = [
            trx.namaPenerima,
            trx.keteranganPembayaran,
            trx.noSurat,
            formatDateDDMMYYYY(trx.tanggalPengeluaran)
        ].join(' ').toLowerCase();
        return searchText.includes(lowerCaseSearchTerm);
    });

    filteredTransactions.forEach(trx => {
        const subtotal = trx.rincianTransaksi.reduce((sum, item) => sum + item.nominal, 0);
        const totalPotongan = trx.rincianPotongan.reduce((sum, item) => sum + item.nominal, 0);
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td class="p-4"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 row-checkbox" data-id="${trx.id}"></td>
            <td class="p-4 whitespace-nowrap text-sm">${formatDateDDMMYYYY(trx.tanggalPengeluaran)}</td>
            <td class="p-4 whitespace-nowrap text-sm font-mono">${trx.noSurat}</td>
            <td class="p-4 whitespace-nowrap text-sm">${trx.namaPenerima}</td>
            <td class="p-4 text-sm truncate max-w-xs">${trx.keteranganPembayaran}</td>
            <td class="p-4 whitespace-nowrap text-sm text-right">${formatRupiah(subtotal)}</td>
            <td class="p-4 whitespace-nowrap text-sm text-right">${formatRupiah(totalPotongan)}</td>
            <td class="p-4 whitespace-nowrap text-sm text-center">
                <div class="flex items-center justify-center space-x-2">
                    <button class="text-blue-500 hover:text-blue-700 action-btn" data-action="pratinjau" data-id="${trx.id}" title="Pratinjau">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    </button>
                    <button class="text-yellow-500 hover:text-yellow-700 action-btn" data-action="edit" data-id="${trx.id}" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button class="text-red-500 hover:text-red-700 action-btn" data-action="hapus" data-id="${trx.id}" title="Hapus">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </div>
            </td>
        `;
    });

    tbody.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', handleRekapAction);
    });
}

function handleRekapAction(e) {
    const button = e.currentTarget;
    const action = button.dataset.action;
    const id = parseInt(button.dataset.id, 10);
    const transaction = appState.transactions.find(t => t.id === id);
    if (!transaction) return;

    switch(action) {
        case 'pratinjau':
            populatePratinjauModal(transaction);
            $('#pratinjau-modal').classList.remove('hidden');
            break;
        case 'edit':
            handleEditTransaction(transaction);
            break;
        case 'hapus':
            if (confirm(`Apakah Anda yakin ingin menghapus kuitansi untuk ${transaction.namaPenerima}?`)) {
                appState.transactions = appState.transactions.filter(t => t.id !== id);
                saveState();
                renderRekapTable();
                showToast('Kuitansi berhasil dihapus.');
            }
            break;
    }
}

function handleEditTransaction(trx) {
    appState.editingTransactionId = trx.id;
    $('.tab-button[data-tab="buat-kuitansi"]').click();

    $('#no-surat').value = trx.noSurat;
    $('#nama-penerima').value = trx.namaPenerima;
    $('#jabatan').value = trx.jabatan;
    $('#keterangan-pembayaran').value = trx.keteranganPembayaran;
    $('#sumber-dana').value = trx.sumberDana;
    $('#jenis-transaksi').value = trx.jenisTransaksi;
    $('#tanggal-pengeluaran').value = trx.tanggalPengeluaran;

    const transaksiContainer = $('#rincian-transaksi-container');
    transaksiContainer.innerHTML = '';
    trx.rincianTransaksi.forEach(item => {
        addTransaksiRow(item);
    });
    
    const potonganContainer = $('#rincian-potongan-container');
    potonganContainer.innerHTML = '';
    if (trx.rincianPotongan && trx.rincianPotongan.length > 0) {
        trx.rincianPotongan.forEach(item => {
            addPotonganRow(item);
        });
    }
    
    $('#simpan-kuitansi').textContent = 'Update Kuitansi';
}

function handleTandaiSemua(e) {
    $$('.row-checkbox').forEach(checkbox => checkbox.checked = e.target.checked);
    updateHapusTerpilihButton();
}

function updateHapusTerpilihButton() {
    const selectedCount = $$('.row-checkbox:checked').length;
    $('#hapus-terpilih').disabled = selectedCount === 0;
}

function handleHapusTerpilih() {
    const selectedIds = Array.from($$('.row-checkbox:checked')).map(cb => parseInt(cb.dataset.id, 10));
    if (selectedIds.length === 0) return;
    
    if (confirm(`Apakah Anda yakin ingin menghapus ${selectedIds.length} kuitansi terpilih?`)) {
        appState.transactions = appState.transactions.filter(t => !selectedIds.includes(t.id));
        saveState();
        renderRekapTable();
        $('#tandai-semua').checked = false;
        updateHapusTerpilihButton();
        showToast(`${selectedIds.length} kuitansi berhasil dihapus.`);
    }
}

function handleExportXLSX() {
    const dataToExport = appState.transactions.map(trx => {
        const subtotal = trx.rincianTransaksi.reduce((sum, item) => sum + item.nominal, 0);
        const totalPotongan = trx.rincianPotongan.reduce((sum, item) => sum + item.nominal, 0);
        return {
            'Tanggal': formatDateDDMMYYYY(trx.tanggalPengeluaran),
            'No. Surat': `'${trx.noSurat}`,
            'Penerima': trx.namaPenerima,
            'Jabatan': trx.jabatan,
            'Keterangan': trx.keteranganPembayaran,
            'Sumber Dana': trx.sumberDana,
            'Nominal': subtotal,
            'Potongan': totalPotongan,
            'Total Diterima': subtotal - totalPotongan
        };
    });

    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Transaksi");
    XLSX.writeFile(workbook, "Rekap_Kuitansi_Q.Itanzee.xlsx");
}

</script>

</body>
</html>

